---
phase: 03-tranzila-payments
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/epox-platform/app/api/billing/subscription/route.ts
  - apps/epox-platform/app/api/billing/plans/route.ts
  - apps/epox-platform/app/api/billing/checkout/route.ts
  - apps/epox-platform/app/api/billing/cancel/route.ts
  - apps/epox-platform/lib/services/billing.ts
  - apps/epox-platform/lib/services/quota.ts
autonomous: true
---

<objective>
Implement billing service with subscription lifecycle and update quota enforcement to use credit balance.

Purpose: Enable clients to subscribe to plans (Basic $49/2000cr, Growth $99/4500cr, Scale $149/7000cr), pay via Tranzila, manage subscriptions, and enforce variable credit costs per operation.
Output: Billing service + subscription API routes + updated quota enforcement.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tranzila-payments/03-01-SUMMARY.md
@.planning/phases/03-tranzila-payments/03-02-SUMMARY.md
@apps/epox-platform/lib/security/middleware.ts
@apps/epox-platform/lib/services/quota.ts
@apps/epox-platform/app/api/dashboard/route.ts
@packages/visualizer-services/src/quota/credit-costs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing service and update quota enforcement</name>
  <files>apps/epox-platform/lib/services/billing.ts, apps/epox-platform/lib/services/quota.ts</files>
  <action>
**1. Create BillingService** in `apps/epox-platform/lib/services/billing.ts`:

Constructor takes TranzilaClient + DatabaseFacade.

Methods:
a) `getPlans()` — return active subscription plans
b) `getCreditPacks()` — return active credit packs
c) `getClientSubscription(clientId)` — get current subscription with plan details
d) `getClientBillingInfo(clientId)` — return subscription + credit balance + usage summary
e) `subscribe(clientId, params: { planName, billingCycle, token, tokenExpDate, last4 })`:
   - Validate plan exists (basic/growth/scale)
   - Check client doesn't have active sub
   - Calculate price: monthly or annual (17% discount)
   - Charge via TranzilaClient.chargeToken
   - Create subscription record (status='active', period start=now, end=+1mo/+1yr)
   - Create billingTransaction (type='subscription_payment', creditsGranted=plan.monthlyCredits)
   - Update quotaLimit: set plan, set creditBalance to plan.monthlyCredits
   - Return subscription
f) `cancelSubscription(clientId, atPeriodEnd)`:
   - Find active sub
   - If atPeriodEnd: set cancelAtPeriodEnd flag (access continues until period end)
   - If immediate: cancel, set plan to 'free', set creditBalance to 0
g) `processRenewal(subscriptionId)`:
   - Load sub + plan
   - If cancelAtPeriodEnd: set status='canceled', downgrade to free, return
   - Charge stored token
   - On fail: set status='past_due'
   - On success: advance period, create transaction, reset creditBalance to plan.monthlyCredits (subscription credits don't roll over), keep lifetimeCredits as-is

Create singleton factory:
```typescript
export function createBillingService(dbInstance: DatabaseFacade): BillingService
```
Uses env vars: TRANZILA_TERMINAL_NAME, TRANZILA_API_APP_KEY, TRANZILA_TRANSACTION_PASSWORD.

**2. Update quota enforcement** in `apps/epox-platform/lib/services/quota.ts`:

Update `enforceQuota` to use the credit balance system:
- Accept `creditCost: number` parameter (from CREDIT_COSTS lookup)
- Check: `quotaLimit.creditBalance + quotaLimit.lifetimeCredits >= creditCost`
- If insufficient: return 402 NextResponse with { error, balance, required, purchaseUrl: '/billing' }
- Uncomment the enforcement check (currently commented out)

Update `consumeCredits` to:
- Accept `creditCost: number`
- Deduct from lifetimeCredits first (they don't expire), then from creditBalance
- Use atomic SQL operation via adjustCreditBalance

The enforcement is currently commented out — this plan activates it with the new credit-based model.
  </action>
  <verify>cd apps/epox-platform && npx tsc --noEmit</verify>
  <done>BillingService with full subscription lifecycle; quota enforcement activated with variable credit costs</done>
</task>

<task type="auto">
  <name>Task 2: Create subscription API routes</name>
  <files>apps/epox-platform/app/api/billing/plans/route.ts, apps/epox-platform/app/api/billing/subscription/route.ts, apps/epox-platform/app/api/billing/checkout/route.ts, apps/epox-platform/app/api/billing/cancel/route.ts</files>
  <action>
Create API routes under `apps/epox-platform/app/api/billing/`:

1. **GET /api/billing/plans**:
   - Use withPublicSecurity (public — pricing page)
   - Return { plans: SubscriptionPlan[], creditPacks: CreditPack[], creditCosts: CREDIT_COSTS }
   - Include credit costs so frontend can display "X credits per generation"

2. **GET /api/billing/subscription**:
   - Use withSecurity
   - Call billingService.getClientBillingInfo(clientId)
   - Return { subscription, plan, creditBalance, lifetimeCredits, totalAvailable, usage: { thisMonth } }
   - Return null subscription if none active (free tier)

3. **POST /api/billing/checkout**:
   - Use withSecurity
   - Zod: { planName: z.enum(['basic','growth','scale']), billingCycle: z.enum(['monthly','annual']), tranzilaToken: z.string(), tokenExpDate: z.string(), last4Digits: z.string() }
   - Call billingService.subscribe()
   - Return 201 with subscription
   - 402 on charge failure, 400 on validation, 409 if already subscribed

4. **POST /api/billing/cancel**:
   - Use withSecurity
   - Zod: { atPeriodEnd: z.boolean().default(true) }
   - Call billingService.cancelSubscription()
   - Return 200 with updated subscription
   - 404 if no active subscription

Follow existing API patterns: withSecurity wrapper, Zod validation, proper status codes, clientId from security context.
  </action>
  <verify>cd apps/epox-platform && npx tsc --noEmit</verify>
  <done>Four billing API routes with auth, validation, and error handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/epox-platform && npx tsc --noEmit` passes
- [ ] GET /api/billing/plans returns plans, packs, and credit costs
- [ ] POST /api/billing/checkout creates subscription and charges token
- [ ] POST /api/billing/cancel handles cancellation
- [ ] GET /api/billing/subscription returns current billing info
- [ ] Quota enforcement activated with variable credit costs
- [ ] Credits deducted correctly (lifetime first, then balance)
</verification>

<success_criteria>
- All tasks completed
- Subscription lifecycle works: subscribe → get status → cancel
- Quota enforcement uses credit balance (not generation count)
- Variable credit costs applied per operation type
- Monthly credits reset on renewal, lifetime credits persist
</success_criteria>

<output>
After completion, create `.planning/phases/03-tranzila-payments/03-03-SUMMARY.md`
</output>
