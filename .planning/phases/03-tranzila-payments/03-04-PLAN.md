---
phase: 03-tranzila-payments
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/epox-platform/app/api/billing/purchase-credits/route.ts
  - apps/epox-platform/app/api/billing/transactions/route.ts
  - apps/epox-platform/app/api/billing/iframe-url/route.ts
autonomous: true
---

<objective>
Implement credit pack one-time purchase API and transaction history.

Purpose: Enable clients to buy the Starter Pack ($29 / 1,200 lifetime credits) via Tranzila and view billing history.
Output: API routes for credit pack purchase, Tranzila iframe URL, and transaction listing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tranzila-payments/03-01-SUMMARY.md
@.planning/phases/03-tranzila-payments/03-02-SUMMARY.md
@apps/epox-platform/lib/services/billing.ts
@apps/epox-platform/lib/security/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit pack purchase and iframe URL routes</name>
  <files>apps/epox-platform/app/api/billing/purchase-credits/route.ts, apps/epox-platform/app/api/billing/iframe-url/route.ts</files>
  <action>
1. **GET /api/billing/iframe-url**:
   - Use withSecurity
   - Return TranzilaClient.getIframeUrl() — the tokenization iframe URL
   - Frontend embeds this iframe; it returns a TranzilaTK token via postMessage when user enters card
   - Response: { iframeUrl: string }

2. **POST /api/billing/purchase-credits**:
   - Use withSecurity
   - Zod: { creditPackId: z.string(), tranzilaToken: z.string(), tokenExpDate: z.string(), last4Digits: z.string() }
   - Look up credit pack from db.creditPacks.getById()
   - 404 if not found or inactive
   - Charge token via TranzilaClient.chargeToken with pack price (USD cents)
   - On success:
     - Create billingTransaction (type='credit_pack', status='completed', creditsGranted=pack.credits)
     - Add lifetime credits: db.quotaLimits.addLifetimeCredits(clientId, pack.credits)
     - Lifetime credits persist across subscription renewals (they never expire)
   - On Tranzila failure:
     - Create billingTransaction (status='failed')
     - Return 402 with error
   - Return 201 with { transaction, creditsAdded: pack.credits, newBalance: { creditBalance, lifetimeCredits, total } }

Starter Pack details: $29 (2900 USD cents) for 1,200 lifetime credits. This is a "pay as you go" pack — credits roll over forever, no subscription needed.
  </action>
  <verify>cd apps/epox-platform && npx tsc --noEmit</verify>
  <done>Credit pack purchase charges token, grants lifetime credits, records transaction</done>
</task>

<task type="auto">
  <name>Task 2: Create transaction history route</name>
  <files>apps/epox-platform/app/api/billing/transactions/route.ts</files>
  <action>
**GET /api/billing/transactions**:
- Use withSecurity
- Query params (Zod validated from URL searchParams):
  - limit: z.coerce.number().min(1).max(100).default(20)
  - offset: z.coerce.number().min(0).default(0)
  - type: z.enum(['subscription_payment','credit_pack','refund']).optional()
- Call db.billingTransactions.listByClient(clientId, { limit, offset, type })
- Return { transactions: [...], total: number, hasMore: boolean }
- Each transaction includes: id, type, amountUsd, currency, creditsGranted, status, description, createdAt

Follow existing API patterns for pagination (limit/offset) and Zod query validation.
  </action>
  <verify>cd apps/epox-platform && npx tsc --noEmit</verify>
  <done>Transaction history endpoint with pagination and type filtering</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/epox-platform && npx tsc --noEmit` passes
- [ ] GET /api/billing/iframe-url returns Tranzila iframe URL
- [ ] POST /api/billing/purchase-credits charges and grants lifetime credits
- [ ] GET /api/billing/transactions returns paginated history
- [ ] Failed charges return 402 and record failed transaction
</verification>

<success_criteria>
- All tasks completed
- Starter Pack purchase works (charge → grant 1200 lifetime credits → record)
- Transaction history available with filtering
- Lifetime credits properly separated from subscription credits
</success_criteria>

<output>
After completion, create `.planning/phases/03-tranzila-payments/03-04-SUMMARY.md`
</output>
