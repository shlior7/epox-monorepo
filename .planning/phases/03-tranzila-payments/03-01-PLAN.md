---
phase: 03-tranzila-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/visualizer-services/src/tranzila/types.ts
  - packages/visualizer-services/src/tranzila/client.ts
  - packages/visualizer-services/src/tranzila/index.ts
  - packages/visualizer-services/src/index.ts
autonomous: true
user_setup:
  - service: tranzila
    why: "Payment processing requires Tranzila API credentials"
    env_vars:
      - name: TRANZILA_TERMINAL_NAME
        source: "Tranzila merchant dashboard → Terminal settings → Terminal name"
      - name: TRANZILA_API_APP_KEY
        source: "Tranzila merchant dashboard → API settings → Application key"
      - name: TRANZILA_TRANSACTION_PASSWORD
        source: "Tranzila merchant dashboard → Terminal settings → Transaction password"
    account_setup:
      - url: "https://www.tranzila.com/"
        skip_if: "Already have Tranzila merchant account"
---

<objective>
Create Tranzila payment gateway client service for token-based charging.

Purpose: Provide a type-safe, testable abstraction over the Tranzila API V2 and legacy CGI endpoints for tokenization, charging, and refunds.
Output: `packages/visualizer-services/src/tranzila/` module exporting TranzilaClient class.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/visualizer-services/src/index.ts
@packages/visualizer-services/src/quota/index.ts
@packages/visualizer-services/src/quota/factory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Tranzila types and configuration</name>
  <files>packages/visualizer-services/src/tranzila/types.ts</files>
  <action>
Create TypeScript types for the Tranzila integration:

1. `TranzilaConfig` — terminal name, API app key, transaction password, base URLs
2. `TokenCreateParams` — iframe-based tokenization request parameters (tranmode=VK)
3. `ChargeParams` — token charge request: supplier, sum, currency (1=ILS, 2=USD), expdate, TranzilaPW, TranzilaTK, optional cred_type for installments
4. `ChargeResult` — response with Response code (000=success), ConfirmationCode, index
5. `RefundParams` — for refund requests (Authnr from original charge, sum)
6. `RefundResult` — refund response
7. `TranzilaError` — custom error class extending Error with response code and description
8. `PaymentRequestParams` — for API V2 payment request creation (POST /v1/pr/create)
9. `PaymentRequestResult` — with payment_request_url

Tranzila API reference from roadmap:
- Token creation iframe: `https://direct.tranzila.com/{terminal}/iframe.php?tranmode=VK`
- Token charge endpoint: `https://secure5.tranzila.com/cgi-bin/tranzila31tk.cgi` (POST form-encoded)
- API V2 base: `https://api.tranzila.com` with `X-tranzila-api-app-key` header
- Payment request: `https://api.tranzila.com/v1/pr/create`

Export all types. Use Zod schemas for response validation (Tranzila returns query-string-encoded responses from CGI endpoint).
  </action>
  <verify>tsc --noEmit from packages/visualizer-services passes</verify>
  <done>All Tranzila types exported, Zod response schemas defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement TranzilaClient service</name>
  <files>packages/visualizer-services/src/tranzila/client.ts, packages/visualizer-services/src/tranzila/index.ts, packages/visualizer-services/src/index.ts</files>
  <action>
Create `TranzilaClient` class in client.ts:

1. Constructor takes `TranzilaConfig` (terminal, appKey, password, optional base URLs for testing)
2. `getIframeUrl(params?: { lang?: string })` — returns the tokenization iframe URL: `https://direct.tranzila.com/{terminal}/iframe.php?tranmode=VK`. This URL is embedded client-side for the user to enter card details. The iframe returns a TranzilaTK token via postMessage.
3. `chargeToken(params: ChargeParams): Promise<ChargeResult>` — POST form-encoded to `https://secure5.tranzila.com/cgi-bin/tranzila31tk.cgi` with supplier={terminal}, TranzilaPW={password}, TranzilaTK={token}, sum, currency, expdate. Parse query-string-encoded response. Throw TranzilaError if Response !== '000'.
4. `refund(params: RefundParams): Promise<RefundResult>` — POST to same CGI endpoint with CreditPass action.
5. `createPaymentRequest(params: PaymentRequestParams): Promise<PaymentRequestResult>` — POST JSON to `https://api.tranzila.com/v1/pr/create` with `X-tranzila-api-app-key` header. This is an alternative to iframe tokenization — creates a hosted payment page URL.

Use native `fetch` for HTTP requests (Node 22 has it built-in). Parse CGI responses by splitting on `&` and `=` pairs. Validate responses with Zod schemas from types.ts.

Do NOT use any npm packages for HTTP — use native fetch.

Create index.ts barrel export: export TranzilaClient, all types, TranzilaError.

Add re-export in packages/visualizer-services/src/index.ts.
  </action>
  <verify>tsc --noEmit from packages/visualizer-services passes; manual review of HTTP request construction</verify>
  <done>TranzilaClient class with chargeToken, refund, createPaymentRequest methods; exported from package root</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd packages/visualizer-services && npx tsc --noEmit` passes
- [ ] TranzilaClient exported from `packages/visualizer-services/src/index.ts`
- [ ] All Tranzila types exported
- [ ] chargeToken, refund, createPaymentRequest methods implemented
- [ ] CGI response parsing handles query-string format
- [ ] Zod validation on responses
</verification>

<success_criteria>
- All tasks completed
- Type-safe Tranzila client ready for use by API routes
- No external HTTP dependencies added (uses native fetch)
- Error handling with TranzilaError class
</success_criteria>

<output>
After completion, create `.planning/phases/03-tranzila-payments/03-01-SUMMARY.md`
</output>
