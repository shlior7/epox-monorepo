---
phase: 03-tranzila-payments
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/visualizer-db/src/schema/billing.ts
  - packages/visualizer-db/src/schema/usage.ts
  - packages/visualizer-db/src/schema/index.ts
  - packages/visualizer-db/src/repositories/billing.ts
  - packages/visualizer-db/src/repositories/usage.ts
  - packages/visualizer-db/src/repositories/index.ts
  - packages/visualizer-db/src/facade.ts
  - packages/visualizer-db/src/__tests__/repositories/billing.test.ts
  - packages/visualizer-services/src/quota/credit-costs.ts
autonomous: true
---

<objective>
Create billing database schema, credit balance system, and repositories for subscriptions, payments, and variable credit costs.

Purpose: Provide the data layer for all payment operations — storing Tranzila tokens, tracking subscription lifecycle, recording transactions, and managing a credit balance with variable per-operation costs.
Output: billing.ts schema, credit cost config, updated quota with credit balance, billing repositories with tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/visualizer-db/src/schema/usage.ts
@packages/visualizer-db/src/schema/index.ts
@packages/visualizer-db/src/repositories/usage.ts
@packages/visualizer-db/src/repositories/base.ts
@packages/visualizer-db/src/facade.ts
@packages/visualizer-services/src/quota/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit cost configuration and billing schema</name>
  <files>packages/visualizer-services/src/quota/credit-costs.ts, packages/visualizer-db/src/schema/billing.ts, packages/visualizer-db/src/schema/usage.ts, packages/visualizer-db/src/schema/index.ts</files>
  <action>
**1. Create credit cost configuration** in `packages/visualizer-services/src/quota/credit-costs.ts`:

Define the credit exchange rates as a typed constant:

```typescript
export const CREDIT_COSTS = {
  // Image generation
  'nano-banana': { // Gemini 2.5 Flash - 1K
    credits: 10,
    label: 'Fast Draft (1K)',
  },
  'nano-banana-pro-std': { // Gemini 3 Pro - 2K
    credits: 12,
    label: 'Pro Scene (2K)',
  },
  'nano-banana-pro-ultra': { // Gemini 3 Pro - 4K
    credits: 8,
    label: 'Pro Scene Ultra (4K)',
  },
  'imagen-product': { // Re-context - 1K (next phase)
    credits: 30,
    label: 'Product Background (1K)',
  },
  'imagen-upscale': { // Upscale addon (next phase)
    credits: 55,
    label: 'Image Upscale (2K/4K)',
  },
  // Video generation
  'veo-fast-4s': { // 720p 4s
    credits: 110,
    label: 'Video Lite (720p 4s)',
  },
  'veo-fast-8s': { // 720p 8s
    credits: 220,
    label: 'Video Lite (720p 8s)',
  },
  'veo-standard-4s': { // 1080p 4s
    credits: 240,
    label: 'Video HD (1080p 4s)',
  },
  'veo-standard-8s': { // 1080p 8s
    credits: 470,
    label: 'Video HD (1080p 8s)',
  },
  'veo-cinema-4s': { // 4K 4s
    credits: 380,
    label: 'Video 4K (4s)',
  },
  'veo-cinema-8s': { // 4K 8s
    credits: 760,
    label: 'Video 4K (8s)',
  },
} as const;

export type CreditOperationType = keyof typeof CREDIT_COSTS;

export function getCreditCost(operation: CreditOperationType): number {
  return CREDIT_COSTS[operation].credits;
}
```

Export from the package index.

**2. Update usage schema** — Add `creditBalance` to the `quotaLimit` table:

In `packages/visualizer-db/src/schema/usage.ts`, add a new column to `quotaLimit`:
- `creditBalance: integer('credit_balance').notNull().default(0)` — current available credits
- `lifetimeCredits: integer('lifetime_credits').notNull().default(0)` — purchased credits that don't expire (starter packs)

Update `PlanType` to match new tiers: `'free' | 'basic' | 'growth' | 'scale' | 'enterprise'`

Keep existing `monthlyGenerationLimit` for backwards compatibility (it can be deprecated later) but the new credit balance system will be the primary mechanism.

**3. Create billing schema** in `packages/visualizer-db/src/schema/billing.ts`:

Tables:

1. **subscriptionPlans** — Plan definitions:
   - id (text, PK)
   - name (text, unique) — 'free', 'basic', 'growth', 'scale', 'enterprise'
   - displayName (text) — 'Free', 'Basic', 'Growth', 'Scale', 'Enterprise'
   - monthlyPriceUsd (integer) — price in USD cents (4900 = $49, 9900 = $99, 14900 = $149)
   - annualPriceUsd (integer) — annual price in USD cents (17% discount)
   - monthlyCredits (integer) — included credits per month (0, 2000, 4500, 7000)
   - maxProducts (integer) — product slot limit (-1 for unlimited)
   - features (jsonb) — feature flags
   - isActive (integer, default 1 — using integer like existing success column pattern)
   - createdAt, updatedAt

2. **subscriptions** — Active client subscriptions:
   - id (text, PK)
   - clientId (text, FK → client.id, indexed, unique — one sub per client)
   - planId (text, FK → subscriptionPlans.id)
   - status (text) — 'active', 'canceled', 'past_due', 'paused'
   - billingCycle (text) — 'monthly', 'annual'
   - currentPeriodStart (timestamp)
   - currentPeriodEnd (timestamp)
   - canceledAt (timestamp, nullable)
   - cancelAtPeriodEnd (integer, default 0)
   - tranzilaToken (text, nullable) — stored payment token for renewals
   - tokenExpDate (text, nullable) — MMYY format
   - last4Digits (text, nullable)
   - createdAt, updatedAt

3. **billingTransactions** — All payment records:
   - id (text, PK)
   - clientId (text, FK → client.id, indexed)
   - subscriptionId (text, FK → subscriptions.id, nullable)
   - type (text) — 'subscription_payment', 'credit_pack', 'refund'
   - amountUsd (integer) — in USD cents
   - currency (text, default 'USD')
   - creditsGranted (integer) — how many credits this transaction added
   - status (text) — 'pending', 'completed', 'failed', 'refunded'
   - tranzilaConfirmation (text, nullable)
   - tranzilaIndex (text, nullable)
   - description (text)
   - metadata (jsonb, nullable)
   - createdAt

4. **creditPacks** — One-time credit pack definitions:
   - id (text, PK)
   - name (text) — 'starter'
   - displayName (text) — 'Starter Pack'
   - credits (integer) — 1200
   - priceUsd (integer) — in USD cents (2900 = $29)
   - isActive (integer, default 1)
   - createdAt

Use `text` for IDs (matching existing schema pattern), `pgTable`, proper indexes. Add to schema/index.ts barrel export.
  </action>
  <verify>cd packages/visualizer-db && npx tsc --noEmit; cd packages/visualizer-services && npx tsc --noEmit</verify>
  <done>Credit costs defined, quota schema updated with creditBalance, four billing tables created</done>
</task>

<task type="auto">
  <name>Task 2: Create billing repositories, update facade, push schema, and test</name>
  <files>packages/visualizer-db/src/repositories/billing.ts, packages/visualizer-db/src/repositories/usage.ts, packages/visualizer-db/src/repositories/index.ts, packages/visualizer-db/src/facade.ts, packages/visualizer-db/src/__tests__/repositories/billing.test.ts</files>
  <action>
**1. Create billing repositories** in `packages/visualizer-db/src/repositories/billing.ts`:

a) **SubscriptionPlanRepository**:
   - `listActive()` — return all active plans ordered by monthlyPriceUsd
   - `getByName(name: string)` — find plan by name
   - `getById(id: string)` — find plan by id
   - `seed()` — upsert the four plans (basic/growth/scale/enterprise + free) for initialization

b) **SubscriptionRepository**:
   - `getByClientId(clientId: string)` — get active subscription (status = 'active' or 'past_due')
   - `create(data)` — create subscription
   - `update(id, data)` — update fields
   - `cancel(id, cancelAtPeriodEnd?: boolean)` — set canceled state
   - `listExpiring(beforeDate: Date)` — subscriptions needing renewal
   - `updatePeriod(id, start: Date, end: Date)` — advance billing period

c) **BillingTransactionRepository**:
   - `create(data)` — create transaction
   - `listByClient(clientId, options?: { limit, offset, type })` — paginated
   - `getById(id: string)` — find by id
   - `updateStatus(id, status, confirmation?, index?)` — update after charge

d) **CreditPackRepository**:
   - `listActive()` — return active packs
   - `getById(id)` — find by id
   - `seed()` — upsert the starter pack

**2. Update QuotaLimitRepository** in usage.ts:
   - Add `adjustCreditBalance(clientId: string, amount: number)` — atomically add/subtract credits using SQL `SET credit_balance = credit_balance + $amount`
   - Add `setCreditBalance(clientId: string, monthlyCredits: number)` — reset to monthly allotment (for subscription renewal)
   - Add `addLifetimeCredits(clientId: string, amount: number)` — increment lifetime credits (for pack purchases)

**3. Register** all new repositories in DatabaseFacade:
   - `db.subscriptionPlans`, `db.subscriptions`, `db.billingTransactions`, `db.creditPacks`

**4. Export** from repositories/index.ts.

**5. Push schema:**
```bash
cd packages/visualizer-db && yarn db:push
```

**6. Write tests** in `billing.test.ts`:
   - SubscriptionPlanRepository: seed, listActive, getByName
   - SubscriptionRepository: create, getByClientId, cancel (both modes), listExpiring, updatePeriod
   - BillingTransactionRepository: create, listByClient with pagination/type filter, updateStatus
   - CreditPackRepository: seed, listActive, getById
   - QuotaLimitRepository additions: adjustCreditBalance (positive and negative), setCreditBalance, addLifetimeCredits

Use test helpers from existing helpers.ts.

Run: `cd packages/visualizer-db && yarn test repositories/billing`
  </action>
  <verify>cd packages/visualizer-db && yarn db:push && yarn test repositories/billing — all pass</verify>
  <done>All billing repositories created and tested, schema pushed, facade updated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd packages/visualizer-db && npx tsc --noEmit` passes
- [ ] `cd packages/visualizer-services && npx tsc --noEmit` passes
- [ ] `cd packages/visualizer-db && yarn db:push` succeeds
- [ ] `cd packages/visualizer-db && yarn test repositories/billing` — all tests pass
- [ ] All repositories accessible via DatabaseFacade
- [ ] Credit costs config exported from visualizer-services
- [ ] quotaLimit has creditBalance and lifetimeCredits columns
</verification>

<success_criteria>
- All tasks completed
- Billing schema with subscriptionPlans, subscriptions, billingTransactions, creditPacks tables
- Credit balance fields added to quotaLimit
- Variable credit cost configuration defined
- All repository methods tested
- Schema pushed to database
</success_criteria>

<output>
After completion, create `.planning/phases/03-tranzila-payments/03-02-SUMMARY.md`
</output>
