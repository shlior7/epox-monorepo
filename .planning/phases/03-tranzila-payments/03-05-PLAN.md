---
phase: 03-tranzila-payments
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - apps/epox-platform/app/(dashboard)/billing/page.tsx
  - apps/epox-platform/components/billing/PricingPlans.tsx
  - apps/epox-platform/components/billing/SubscriptionStatus.tsx
  - apps/epox-platform/components/billing/CreditPackPurchase.tsx
  - apps/epox-platform/components/billing/TranzilaCheckout.tsx
  - apps/epox-platform/components/billing/TransactionHistory.tsx
  - apps/epox-platform/components/billing/CreditCostTable.tsx
  - apps/epox-platform/lib/hooks/use-billing.ts
autonomous: false
---

<objective>
Build billing UI: subscription plans, credit pack purchase, Tranzila checkout, credit cost transparency, and transaction history.

Purpose: Give clients a self-serve interface to subscribe (Basic/Growth/Scale), buy credit packs ($29 Starter), see credit costs per operation, and view billing history.
Output: /billing dashboard page with all billing components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tranzila-payments/03-03-SUMMARY.md
@.planning/phases/03-tranzila-payments/03-04-SUMMARY.md
@apps/epox-platform/app/(dashboard)/settings/page.tsx
@apps/epox-platform/lib/api-client.ts
@apps/epox-platform/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing hooks and page layout</name>
  <files>apps/epox-platform/lib/hooks/use-billing.ts, apps/epox-platform/app/(dashboard)/billing/page.tsx</files>
  <action>
**1. Create `use-billing.ts`** with TanStack Query hooks:
- `usePlans()` — GET /api/billing/plans (cached, staleTime: 5min)
- `useSubscription()` — GET /api/billing/subscription (refetch on window focus)
- `useTransactions(options?)` — GET /api/billing/transactions with pagination params
- `useCheckout()` — mutation POST /api/billing/checkout, invalidates subscription query on success
- `usePurchaseCredits()` — mutation POST /api/billing/purchase-credits, invalidates subscription query
- `useCancelSubscription()` — mutation POST /api/billing/cancel, invalidates subscription query
- `useIframeUrl()` — GET /api/billing/iframe-url

Use queryOptions API. Follow patterns from existing hooks in lib/hooks/.

**2. Create `/billing` page** at `apps/epox-platform/app/(dashboard)/billing/page.tsx`:
- Server component wrapper that renders client components
- Layout sections (top to bottom):
  1. SubscriptionStatus — current plan, credits remaining, renewal date
  2. PricingPlans — subscription tier cards
  3. CreditPackPurchase — one-time Starter Pack purchase
  4. CreditCostTable — transparency: credit costs per operation
  5. TransactionHistory — paginated billing history
- Add "Billing" link to sidebar navigation (find existing sidebar and add the link)
- data-testid on page container: "billing-page"
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Billing page with hooks, accessible from sidebar</done>
</task>

<task type="auto">
  <name>Task 2: Build billing components</name>
  <files>apps/epox-platform/components/billing/PricingPlans.tsx, apps/epox-platform/components/billing/SubscriptionStatus.tsx, apps/epox-platform/components/billing/CreditPackPurchase.tsx, apps/epox-platform/components/billing/TranzilaCheckout.tsx, apps/epox-platform/components/billing/TransactionHistory.tsx, apps/epox-platform/components/billing/CreditCostTable.tsx</files>
  <action>
Create six components in `apps/epox-platform/components/billing/`:

1. **SubscriptionStatus.tsx** — Current billing overview:
   - Shows plan name badge, billing cycle, next renewal date
   - Credit gauge: subscription credits used vs total (e.g., "1,247 / 4,500 subscription credits")
   - Separate display for lifetime credits ("+ 800 lifetime credits")
   - Total available: "2,053 credits available"
   - Progress bar for subscription credit usage
   - "Cancel Subscription" with Radix AlertDialog confirmation
   - If no sub: "Free Plan" state with CTA "Upgrade Now"
   - If cancelAtPeriodEnd: warning banner "Your plan cancels on {date}"
   - data-testid="subscription-status"

2. **PricingPlans.tsx** — Subscription tier cards in a responsive grid:
   - Cards for Basic ($49/mo, 2000 credits), Growth ($99/mo, 4500 credits), Scale ($149/mo, 7000 credits)
   - Toggle: Monthly / Annual (17% discount, show savings)
   - Each card shows: price, credits included, max products, key features
   - "Most Popular" badge on Growth plan
   - Current plan highlighted with "Current Plan" badge, disabled button
   - "Subscribe" button opens TranzilaCheckout modal
   - Show capacity scenarios: "~450 fast drafts OR ~40 video lite clips"
   - data-testid="pricing-plans"

3. **CreditPackPurchase.tsx** — One-time starter pack:
   - Card for Starter Pack: $29 / 1,200 lifetime credits
   - Highlight "Lifetime — never expires"
   - Show capacity: "~120 fast drafts OR ~10 video lite clips"
   - "Buy Credits" button opens TranzilaCheckout in credit-pack mode
   - data-testid="credit-pack-purchase"

4. **TranzilaCheckout.tsx** — Payment modal:
   - Radix Dialog with Framer Motion transitions
   - Displays order summary (plan name + price, or pack name + price)
   - Embeds Tranzila iframe for card tokenization
   - Listens for postMessage from iframe with token data
   - On token: calls checkout or purchase-credits mutation
   - States: idle → entering-card → processing → success / error
   - Success: green checkmark + "You now have X credits"
   - Error: retry button + error message
   - Props: { mode: 'subscription'|'credit-pack', planName?, creditPackId?, billingCycle?, onSuccess, onClose }
   - data-testid="tranzila-checkout"

5. **CreditCostTable.tsx** — Credit cost transparency:
   - Table showing all AI operations and their credit costs
   - Grouped by category: Image Generation, Video Generation
   - Columns: Operation, Output Quality, Credits
   - Icons for each category (Image, Video)
   - Helps users understand value: "1 fast draft = 10 credits"
   - data-testid="credit-cost-table"

6. **TransactionHistory.tsx** — Billing history:
   - Table: Date, Type, Description, Credits, Amount, Status
   - Status badges: completed (green), failed (red), pending (yellow), refunded (orange)
   - Type filter dropdown (All, Subscription, Credit Pack, Refund)
   - "Load More" pagination button
   - Empty state: "No transactions yet"
   - data-testid="transaction-history"

Style with Tailwind + Radix UI primitives (Dialog, Select, Badge, Table, AlertDialog). Use Framer Motion for checkout modal. Every component/section/card/button gets unique data-testid. Follow existing app design language — check the settings page for visual patterns.

Do NOT use generic fonts or cliche color schemes. Match the existing app aesthetic.
  </action>
  <verify>tsc --noEmit passes, npm run build succeeds</verify>
  <done>Six billing components with proper data-testid, responsive design, Tranzila iframe integration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete billing page at /billing with subscription plans (Basic/Growth/Scale), Starter Pack purchase, Tranzila checkout modal, credit cost transparency table, subscription status with credit gauge, and transaction history</what-built>
  <how-to-verify>
    1. Run: cd apps/epox-platform && yarn dev
    2. Visit: http://localhost:3000/billing
    3. Sidebar: "Billing" link present and navigates correctly
    4. Subscription Status: Shows "Free Plan" with upgrade CTA
    5. Pricing Plans: Three tier cards with monthly/annual toggle
    6. Credit Pack: Starter Pack card with $29 / 1,200 credits
    7. Credit Costs: Table showing all operation costs (10-760 credits range)
    8. Transactions: Empty state displayed
    9. Click "Subscribe" on Growth plan: Checkout modal opens
    10. Click "Buy Credits" on Starter Pack: Checkout modal opens in pack mode
    11. Mobile (375px): All sections stack vertically, no horizontal scroll
    12. Check: No console errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/epox-platform && npx tsc --noEmit` passes
- [ ] `cd apps/epox-platform && npm run build` succeeds
- [ ] /billing page accessible from sidebar
- [ ] All six components render correctly
- [ ] Tranzila iframe loads in checkout modal
- [ ] Credit costs displayed accurately
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- Billing page fully functional with all components
- Subscription tiers show correct prices and credit amounts
- Credit cost table matches the exchange rate table
- Tranzila checkout modal with iframe integration
- User approved layout
</success_criteria>

<output>
After completion, create `.planning/phases/03-tranzila-payments/03-05-SUMMARY.md`
</output>
