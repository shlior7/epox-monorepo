---
phase: phase-2-admin-credits
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/visualizer-db/src/schema/usage.ts
  - packages/visualizer-db/src/schema/index.ts
  - packages/visualizer-db/src/repositories/usage.ts
  - packages/visualizer-db/src/facade.ts
  - apps/epox-admin/app/api/admin/clients/[id]/quota/route.ts
  - apps/epox-admin/app/api/admin/clients/[id]/credits/route.ts
autonomous: true
---

<objective>
Create the admin credit management API: audit trail table for tracking credit grants, and two admin API endpoints for updating client quota/plan and granting credits.

Purpose: Enable admins to manage design partner credits before payment integration exists.
Output: Credit audit log table with repository, PUT quota endpoint, POST credits endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/phase-1-credit-system/01-01-SUMMARY.md
@.planning/phases/phase-1-credit-system/01-02-SUMMARY.md

# Existing code to understand patterns:
@packages/visualizer-db/src/schema/usage.ts
@packages/visualizer-db/src/repositories/usage.ts
@packages/visualizer-db/src/facade.ts
@packages/visualizer-db/src/schema/index.ts
@apps/epox-admin/lib/security/admin-middleware.ts
@apps/epox-admin/app/api/admin/clients/[id]/route.ts
@packages/visualizer-services/src/quota/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credit audit log schema, repository, and facade registration</name>
  <files>
    packages/visualizer-db/src/schema/usage.ts,
    packages/visualizer-db/src/schema/index.ts,
    packages/visualizer-db/src/repositories/usage.ts,
    packages/visualizer-db/src/facade.ts
  </files>
  <action>
1. **Schema** (`packages/visualizer-db/src/schema/usage.ts`): Add `creditAuditLog` table:
   - `id`: text PK
   - `clientId`: text FK to client, cascade delete
   - `adminId`: text (admin user ID who performed the action)
   - `action`: text, typed as `'plan_change' | 'credit_grant' | 'limit_change' | 'usage_reset'`
   - `details`: jsonb — stores action-specific data (e.g., `{ from: 'free', to: 'pro' }` for plan changes, `{ amount: 500, reason: 'Design partner onboarding' }` for credit grants)
   - `previousValue`: text | null — snapshot of previous state (e.g., previous plan name, previous limit)
   - `newValue`: text | null — snapshot of new state
   - `createdAt`: timestamp, defaultNow
   - Index on `(clientId, createdAt)` for querying audit log by client
   - Add relations to client table
   - Export the table, type, and relations from schema/index.ts

2. **Repository** (`packages/visualizer-db/src/repositories/usage.ts`): Add `CreditAuditLogRepository` class:
   - Extend `BaseRepository<CreditAuditLog>`
   - `create(data: CreateAuditLogEntry)`: Insert new audit entry
   - `listByClient(clientId, options?: { limit?: number, offset?: number })`: Get audit entries for a client, ordered by createdAt DESC
   - Interface `CreditAuditLog` with all fields
   - Interface `CreateAuditLogEntry` with required fields (clientId, adminId, action, details), optional (previousValue, newValue)
   - Export the type `AuditAction = 'plan_change' | 'credit_grant' | 'limit_change' | 'usage_reset'`

3. **Facade** (`packages/visualizer-db/src/facade.ts`): Register `creditAuditLogs: CreditAuditLogRepository` in DatabaseFacade interface and proxy initialization, following the existing pattern for other repositories.

4. **Run `drizzle-kit generate`** to create migration SQL from schema changes. Command: `cd packages/visualizer-db && npx drizzle-kit generate`
  </action>
  <verify>
    - `cd packages/visualizer-db && npx tsc --noEmit` passes
    - Migration SQL file generated in `packages/visualizer-db/drizzle/`
    - `db.creditAuditLogs` is accessible in TypeScript
  </verify>
  <done>
    - creditAuditLog table defined in schema with proper types and indexes
    - CreditAuditLogRepository with create and listByClient methods
    - Registered in DatabaseFacade
    - Migration generated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin API endpoints for quota management and credit granting</name>
  <files>
    apps/epox-admin/app/api/admin/clients/[id]/quota/route.ts,
    apps/epox-admin/app/api/admin/clients/[id]/credits/route.ts
  </files>
  <action>
1. **PUT `/api/admin/clients/[id]/quota`** (`apps/epox-admin/app/api/admin/clients/[id]/quota/route.ts`):
   - Wrap with `withAdminWriteSecurity`
   - Accept JSON body: `{ plan?: PlanType, monthlyGenerationLimit?: number, storageQuotaMb?: number }`
   - Validate `plan` is one of: free, starter, pro, enterprise (if provided)
   - Validate limits are positive integers (if provided)
   - Get current quota via `db.quotaLimits.getByClientId(id)` — if null, use `db.quotaLimits.getOrCreate(id)` first
   - Update via `db.quotaLimits.update(id, updates)`
   - If plan changes, also update monthlyGenerationLimit and storageQuotaMb to match PLAN_LIMITS defaults (import from `visualizer-services/src/quota/types`). Allow override if explicitly provided in body.
   - Create audit log entry via `db.creditAuditLogs.create()` with action `'plan_change'` or `'limit_change'`
   - Log admin action: `console.log(\`Admin ${adminSession.email} updated quota for client ${id}\`)`
   - Return updated quota object
   - Also add a GET handler (using `withAdminReadSecurity`) that returns current quota + usage + recent audit log (last 10 entries) for the client

2. **POST `/api/admin/clients/[id]/credits`** (`apps/epox-admin/app/api/admin/clients/[id]/credits/route.ts`):
   - Wrap with `withAdminWriteSecurity`
   - Accept JSON body: `{ action: 'grant' | 'reset', amount?: number, reason?: string }`
   - For `action: 'grant'`: Increase `monthlyGenerationLimit` by `amount` on the quota (effectively granting extra credits for this period). Require `amount` > 0.
   - For `action: 'reset'`: Reset current month's `generationCount` to 0 by updating the usage record. This lets the admin give a fresh start.
   - Validate client exists via `db.clients.getById(id)`, return 404 if not
   - Create audit log entry with appropriate action type and details including reason
   - Return updated quota status (current usage, new limit, remaining)

Follow the existing admin API route pattern from `apps/epox-admin/app/api/admin/clients/[id]/route.ts`:
- Use `withAdminWriteSecurity` wrapper
- Extract params via `const { id } = await routeContext.params`
- Return `NextResponse.json()` responses
- Handle errors with try/catch returning 500
  </action>
  <verify>
    - `cd apps/epox-admin && npx tsc --noEmit` passes (or project-level type check)
    - Both route files export correct HTTP method handlers
    - No import errors
  </verify>
  <done>
    - PUT /api/admin/clients/[id]/quota updates plan and limits with audit logging
    - GET /api/admin/clients/[id]/quota returns quota + usage + audit log
    - POST /api/admin/clients/[id]/credits grants credits or resets usage with audit logging
    - All endpoints use withAdminWriteSecurity/withAdminReadSecurity
    - All mutations create audit log entries
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation passes for both `packages/visualizer-db` and `apps/epox-admin`
- [ ] Migration file generated for credit_audit_log table
- [ ] New repository registered in DatabaseFacade
- [ ] Both API endpoints follow admin security middleware pattern
- [ ] All mutations create audit trail entries
</verification>

<success_criteria>

- All tasks completed
- Credit audit log table with schema, repository, and facade registration
- Admin quota management API (PUT quota, POST credits, GET quota) functional
- Audit trail created for all admin credit operations
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/phase-2-admin-credits/02-01-SUMMARY.md`
</output>
