---
phase: phase-2-admin-credits
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/epox-admin/app/admin/clients/[id]/page.tsx
  - apps/epox-admin/styles/admin.scss
autonomous: true
---

<objective>
Add credit management UI to the admin client detail page: plan selector, credit granting form, usage reset, and audit log display.

Purpose: Give admins a visual interface to manage design partner credits without direct DB access.
Output: Interactive credit management section on the client detail page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/phase-2-admin-credits/02-01-PLAN.md

# Existing UI to modify:
@apps/epox-admin/app/admin/clients/[id]/page.tsx
@apps/epox-admin/styles/admin.scss

# API endpoints created in 02-01:
# GET /api/admin/clients/[id]/quota — returns { quota, usage, auditLog }
# PUT /api/admin/clients/[id]/quota — updates plan/limits
# POST /api/admin/clients/[id]/credits — grants credits or resets usage
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credit management form to client detail page</name>
  <files>
    apps/epox-admin/app/admin/clients/[id]/page.tsx,
    apps/epox-admin/styles/admin.scss
  </files>
  <action>
Replace the existing read-only "Quota & Plan" section in the client detail page with an interactive credit management section. The page currently shows plan, monthly generations (usage/limit), and storage quota as read-only text.

**New "Credit Management" section should include:**

1. **Plan Selector**: Dropdown to change plan (free/starter/pro/enterprise). When changed, show what the new default limits will be. Submit via PUT `/api/admin/clients/[id]/quota`.

2. **Limit Override**: Input fields for `monthlyGenerationLimit` and `storageQuotaMb`. Pre-filled with current values. Allow admin to set custom limits that differ from plan defaults. Submit via PUT `/api/admin/clients/[id]/quota`.

3. **Credit Grant Form**:
   - Number input for amount (extra credits to add)
   - Text input for reason (e.g., "Design partner onboarding bonus")
   - "Grant Credits" button
   - Submit via POST `/api/admin/clients/[id]/credits` with `{ action: 'grant', amount, reason }`

4. **Usage Reset Button**:
   - "Reset Usage" button with confirmation
   - Shows current usage count before reset
   - Submit via POST `/api/admin/clients/[id]/credits` with `{ action: 'reset', reason }`

5. **Current Status Display**:
   - Show current plan, usage/limit, remaining credits, usage percentage with progress bar (keep existing progress bar style)
   - Show storage quota

**Implementation details:**
- Add state variables for form inputs (plan, limits, creditAmount, reason)
- Add loading/success/error states for form submissions
- After any mutation, refetch client data to update the display
- Use existing CSS class naming convention: `admin-client-detail__credit-*`
- Add `data-testid` attributes to all interactive elements:
  - `data-testid="credit-management-section"`
  - `data-testid="plan-selector"`
  - `data-testid="limit-monthly-input"`
  - `data-testid="limit-storage-input"`
  - `data-testid="credit-amount-input"`
  - `data-testid="credit-reason-input"`
  - `data-testid="grant-credits-button"`
  - `data-testid="reset-usage-button"`
  - `data-testid="save-quota-button"`
- Show success/error feedback after mutations (simple inline message, disappears after 3 seconds)
- Use existing Lucide icons: `CreditCard` for credit section, `RefreshCw` for reset

**Styling:** Add corresponding SCSS to `apps/epox-admin/styles/admin.scss` following existing patterns. The admin app uses BEM-style class naming under `.admin-client-detail`. Use the existing color variables from `_variables.scss`. Keep the form compact — inline inputs where possible, not full-width blocks.
  </action>
  <verify>
    - `cd apps/epox-admin && npx tsc --noEmit` passes
    - No import errors
    - All data-testid attributes present
  </verify>
  <done>
    - Plan selector dropdown functional
    - Limit override inputs functional
    - Credit grant form with amount + reason functional
    - Usage reset button with confirmation functional
    - All mutations call correct API endpoints
    - Success/error feedback shown after mutations
    - UI refreshes after mutations
  </done>
</task>

<task type="auto">
  <name>Task 2: Add audit log display to client detail page</name>
  <files>
    apps/epox-admin/app/admin/clients/[id]/page.tsx,
    apps/epox-admin/styles/admin.scss
  </files>
  <action>
Add an "Audit Log" subsection below the credit management form that displays recent credit-related admin actions.

**Implementation:**

1. **Fetch audit log**: The GET `/api/admin/clients/[id]/quota` endpoint returns `auditLog` array. Fetch this on page load alongside the existing client data fetch.

2. **Display format**: A compact table/list showing:
   - Date/time (formatted as relative time if < 24h, otherwise date)
   - Action type badge (color-coded: plan_change=blue, credit_grant=green, limit_change=yellow, usage_reset=red)
   - Details (parsed from JSON details field — show human-readable summary)
   - Admin ID (who performed it)

3. **Data-testid attributes:**
   - `data-testid="audit-log-section"`
   - `data-testid="audit-log-entry"` on each row

4. **Empty state**: "No credit management activity yet" message when audit log is empty.

5. **Limit display to 10 most recent entries** (API already limits this).

**Styling:** Follow the existing list pattern from the Members and Products sections (`.admin-client-detail__list` and `.admin-client-detail__list-item`). Add color-coded action badges using existing badge pattern (`.admin-client-detail__badge`).

**Detail rendering by action type:**
- `plan_change`: "Changed plan from {previousValue} to {newValue}"
- `credit_grant`: "Granted {details.amount} credits — {details.reason}"
- `limit_change`: "Updated limits: {details summary}"
- `usage_reset`: "Reset monthly usage to 0 — {details.reason}"
  </action>
  <verify>
    - `cd apps/epox-admin && npx tsc --noEmit` passes
    - Audit log section renders with proper formatting
    - Empty state shown when no entries
  </verify>
  <done>
    - Audit log section displays recent credit management actions
    - Entries show date, action type badge, details, admin info
    - Color-coded action badges
    - Empty state message when no entries
    - Auto-updates after credit mutations
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation passes for `apps/epox-admin`
- [ ] Credit management section replaces old read-only quota display
- [ ] All form submissions call correct API endpoints
- [ ] Audit log displays after mutations
- [ ] All interactive elements have data-testid attributes
- [ ] No visual regression in other sections of client detail page
</verification>

<success_criteria>

- All tasks completed
- Admin can change plan, set custom limits, grant credits, reset usage from the UI
- Audit log shows all credit management actions
- UI provides feedback on success/error
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/phase-2-admin-credits/02-02-SUMMARY.md`
</output>
