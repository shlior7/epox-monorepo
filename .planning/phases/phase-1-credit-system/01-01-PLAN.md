---
wave: 1
autonomous: true
---

# Plan 01-01: Wire QuotaService to Real DB & Replace Hardcoded Credits

## Goal
Connect the existing QuotaService to real database repositories and replace hardcoded `500` credits in dashboard endpoints with live quota data.

## Tasks

### Task 1: Create QuotaService factory wired to DB repositories
**Files:** `packages/visualizer-services/src/quota/factory.ts`, `packages/visualizer-services/src/quota/index.ts`

Create a factory function that instantiates QuotaService with real DB dependencies:
- `getUsage` → `db.usageRecords.getCurrentUsage(clientId)`
- `incrementUsage` → `db.usageRecords.incrementUsage(clientId, undefined, count)`
- `getClientPlan` → `db.quotaLimits.getOrCreate(clientId)` → return plan field

Export from `packages/visualizer-services/src/quota/index.ts`.

### Task 2: Replace hardcoded credits in dashboard API route
**Files:** `apps/epox-platform/app/api/dashboard/route.ts`

Replace `creditsRemaining: 500` with:
- Import and use the quota service factory
- Call `quotaService.getQuotaStatus(clientId)`
- Return real `creditsRemaining`, `creditsTotal`, `plan`, `usagePercent`, `resetDate`

### Task 3: Replace hardcoded credits in SSR queries
**Files:** `apps/epox-platform/lib/server/queries.ts`

Replace `creditsRemaining: 500` with real quota data, same approach as Task 2.

### Task 4: Update dashboard client to use real quota data
**Files:** `apps/epox-platform/app/(dashboard)/dashboard/dashboard-client.tsx`

Replace hardcoded `creditsTotal: 1000` and `creditsResetAt` calculation with data from the API response. Use the new `creditsTotal`, `plan`, `usagePercent`, `resetDate` fields.

## Dependencies
None — this is the foundation plan.

## Verification
- Dashboard shows real credit data from DB instead of hardcoded 500
- New clients get `free` plan with 100 monthly generations via `getOrCreate`
- QuotaService factory can be imported and used from any service
