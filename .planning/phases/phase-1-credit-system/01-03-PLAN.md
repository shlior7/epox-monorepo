---
wave: 2
autonomous: true
---

# Plan 01-03: Add Quota Service and Enforcement Tests

## Goal
Add tests for the QuotaService factory, quota enforcement helper, and verify credit deduction in API routes.

## Tasks

### Task 1: Add QuotaService integration tests
**Files:** `packages/visualizer-db/src/__tests__/repositories/usage.test.ts` (extend existing or create)

Test UsageRecordRepository and QuotaLimitRepository methods:
- `getCurrentUsage` returns 0 for new clients
- `incrementUsage` increments correctly
- `getOrCreate` creates free plan for new clients
- `getByClientAndMonth` returns correct month data

### Task 2: Add QuotaService unit tests
**Files:** `packages/visualizer-services/src/quota/__tests__/service.test.ts`

Test QuotaService with mocked dependencies:
- `checkQuota` allows when under limit
- `checkQuota` denies when at limit
- `consumeQuota` increments usage
- `consumeQuota` denies when at limit
- `getQuotaStatus` returns correct percentages
- Enterprise plan is unlimited

### Task 3: Add quota enforcement API tests
**Files:** `apps/epox-platform/__tests__/api/quota-enforcement.test.ts`

Test the quota enforcement helper:
- `enforceQuota` passes when credits available
- `enforceQuota` throws when credits exhausted
- `consumeCredits` increments usage count
- Integration with mocked DB

## Dependencies
Plan 01-01 and 01-02 (code must exist to test)

## Verification
- All tests pass: `cd packages/visualizer-db && yarn test`
- All tests pass: `cd packages/visualizer-services && yarn test` (if test config exists)
- All tests pass: `cd apps/epox-platform && yarn test`
