---
wave: 2
autonomous: true
---

# Plan 01-02: Add Quota Enforcement to AI Generation Endpoints

## Goal
Add credit checking and consumption to all AI-powered API endpoints so generation is blocked when credits are exhausted.

## Tasks

### Task 1: Create quota enforcement middleware helper
**Files:** `apps/epox-platform/lib/services/quota.ts`

Create a helper module that:
- Exports a `getQuotaService()` singleton (using the factory from visualizer-services)
- Exports `enforceQuota(clientId: string, count?: number)` that calls `checkQuota` and throws a 402-compatible error if not allowed
- Exports `consumeCredits(clientId: string, count?: number)` that calls `consumeQuota`

### Task 2: Add quota enforcement to image generation endpoint
**Files:** `apps/epox-platform/app/api/generate-images/route.ts`

Before enqueuing: call `enforceQuota(clientId, expectedImageCount)`. After successful enqueue: call `consumeCredits(clientId, expectedImageCount)`.

### Task 3: Add quota enforcement to video generation endpoint
**Files:** `apps/epox-platform/app/api/generate-video/route.ts`

Before enqueuing: call `enforceQuota(clientId, 1)`. After successful enqueue: call `consumeCredits(clientId, 1)`.

### Task 4: Add quota enforcement to image edit endpoint
**Files:** `apps/epox-platform/app/api/edit-image/route.ts`

Before enqueuing: call `enforceQuota(clientId, 1)`. After successful enqueue: call `consumeCredits(clientId, 1)`.

### Task 5: Add quota enforcement to upscale image endpoint
**Files:** `apps/epox-platform/app/api/upscale-image/route.ts`

Before processing: call `enforceQuota(clientId, 1)`. After success: call `consumeCredits(clientId, 1)`.

### Task 6: Add quota enforcement to remove background endpoint
**Files:** `apps/epox-platform/app/api/remove-background/route.ts`

Before processing: call `enforceQuota(clientId, 1)`. After success: call `consumeCredits(clientId, 1)`.

### Task 7: Add quota enforcement to collection generation endpoint
**Files:** `apps/epox-platform/app/api/collections/[id]/generate/route.ts`

Calculate total expected images across all flows. Before enqueuing: call `enforceQuota(clientId, totalExpectedImages)`. After successful enqueue: call `consumeCredits(clientId, totalExpectedImages)`.

## Dependencies
Plan 01-01 (QuotaService factory must exist)

## Verification
- Generation endpoints return 402 when credits exhausted
- Credits are consumed on successful generation enqueue
- Usage count increments in DB after each generation
- Non-AI endpoints (image-transform, process-adjustments, art-director) are NOT gated
